# 文件上传

# Upload

## 图片上传

```js
class UploadThumb extends PureComponent {
  constructor(props) {
    super(props);
    this.state = {
      loading: false,
      imageUrl: ''
    };
  }

  handleChange(info) {
    if (info.file.status === 'uploading') {
      this.setState({ loading: true });
      return;
    }
    if (info.file.status === 'done') {
      // Get this url from response in real world.
      this.getBase64(info.file.originFileObj, imageUrl =>
        this.setState({ imageUrl, loading: false })
      );
    }
  }

  getBase64(img, callback) {
    const reader = new FileReader();
    reader.addEventListener('load', () => callback(reader.result));
    reader.readAsDataURL(img);
  }

  beforeUpload(file) {
    const isJPG = file.type === 'image/jpeg';
    if (!isJPG) {
      message.error('You can only upload JPG file!');
    }
    const isLt2M = file.size / 1024 / 1024 < 2;
    if (!isLt2M) {
      message.error('Image must smaller than 2MB!');
    }
    return isJPG && isLt2M;
  }

  render() {
    const uploadButton = (
      <div>
        <Icon type={this.state.loading ? 'loading' : 'plus'} />
        <div className="ant-upload-text">Upload</div>
      </div>
    );

    return (
      <Upload
        name="avatar"
        listType="picture-card"
        className="avatar-uploader"
        showUploadList={false}
        action="/upload"
        beforeUpload={this.beforeUpload.bind(this)}
        onChange={this.handleChange.bind(this)}
      >
        {this.state.imageUrl ? (
          <img src={this.state.imageUrl} alt="" />
        ) : (
          uploadButton
        )}
      </Upload>
    );
  }
}
```

## 文件转换

```js
const props = {
  action: 'https://www.mocky.io/v2/5cc8019d300000980a055e76',
  transformFile(file) {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        const canvas = document.createElement('canvas');
        const img = document.createElement('img');
        img.src = reader.result;
        img.onload = () => {
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          ctx.fillStyle = 'red';
          ctx.textBaseline = 'middle';
          ctx.fillText('Ant Design', 20, 20);
          canvas.toBlob(resolve);
        };
      };
    });
  }
};

ReactDOM.render(
  <div>
    <Upload {...props}>
      <Button>
        <Icon type="upload" /> Upload
      </Button>
    </Upload>
  </div>,
  mountNode
);
```

# OSS

阿里云 OSS 在内部和外部使用广泛，对国内用户是一个很实用的案例。

![](https://s2.ax1x.com/2019/09/05/nu1JJA.md.png)

首先从服务端获取 OSS 令牌，用的 browser 版本 sdk 的 ali-oss，根据 OSS 相关信息创建 ossClient，然后使用类似 `ossClient.put(path, file)` 的方法上传，并更新 Upload 里的 fileList。

首先构建 ossClientCreator：

```js
const OSS = require('ali-oss');

export interface IOssConfig {
  accessKeyId: string;
  accessKeySecret: string;
  securityToken: string;
  region: string;
  bucket: string;
  endpoint: string;
  [propName: string]: any;
}

export default (ossConfig: IOssConfig) => {
  return new OSS({
    accessKeyId: ossConfig.accessKeyId,
    accessKeySecret: ossConfig.accessKeySecret,
    stsToken: ossConfig.securityToken,
    region: ossConfig.region,
    bucket: ossConfig.bucket
  });
};
```

```js
import http from '../httpService';
import { IOssConfig } from 'src/utils/ossClientCreator';

export async function getOssConfig(): Promise<IOssConfig> {
  let res = await http.post('/api/services/app/Util/OssToken');
  return res.data.result;
}

export async function multipartUpload(ossClient: any, path: string, file: File) {
  let ossRes = await ossClient.multipartUpload(path, file);
  let url: string = '';
  if (ossRes && ossRes.name) {
    url = `http://${ossClient.options.bucket}.${ossClient.options.endpoint.host}/${ossRes.name}`;
  } else {
    throw new Error('上传失败');
  }
  ossClient = null;
  return url;
}

export async function put(ossClient: any, path: string, file: File) {
  let ossRes = await ossClient.put(path, file);

  let url: string = '';
  if (ossRes && ossRes.name) {
    url = `http://${ossClient.options.bucket}.${ossClient.options.endpoint.host}/${ossRes.name}`;
  } else {
    throw new Error('上传失败');
  }
  ossClient = null;
  return url;
}

export async function upload(ossClient: any, path: string, file: File) {
  let size = file.size / 1024;
  if (size > 100 * 1024) {
   throw new Error( '附件大小不能超过100M')；
  }
  if (size > 50 * 1024) {
    return await multipartUpload(ossClient, path, file);
  }
  let result = await ossClient.put(path, file);
  // console.log(result, '上传成功');
  let url: string = '';
  if (result && result.name) {
    url = `http://${ossClient.options.bucket}.${ossClient.options.endpoint.host}/${result.name}`;
  } else {
    throw new Error('上传失败');
  }
  ossClient = null;
  return url;
}

export default {
  getOssConfig,
  multipartUpload,
  put,
  upload,
};
```

在上传组件的加载完毕的事件中，加载 OSS 配置：

```js
async componentDidMount() {
    const config = await ossService.getOssConfig();
    this.client = ossClientCreator(config);
  }
```

然后如下封装 Antd 的 Upload 组件：

```js
<Upload
  customRequest={(e: any) => {
    if (!this.client) return;
    ossService
      .put(
        this.client,
        'upload/' +
          e.file.uid.replace(/-/g, '') +
          '.' +
          e.file.type.match(/image\/(\w*)/)[1],
        e.file
      )
      .then((url: any) => {
        let index = this.state.fileList.findIndex(
          (n: UploadFile) => n.uid === e.file.uid
        );
        if (index > -1) {
          this.state.fileList[index].url = url;
          this.state.fileList[index].status = 'done';
        } else {
          this.state.fileList.push({
            ...e.file,
            status: 'done',
            url: url
          });
        }
        const { onUpdate } = this.props;
        if (onUpdate) {
          onUpdate(this.state.fileList);
        }
        this.setState({
          fileList: this.state.fileList
        });
      });
  }}
  listType="picture-card"
  fileList={fileList}
  onPreview={this.handlePreview}
  onChange={this.handleChange}
  onRemove={this.handleRemove}
  multiple={true}
>
  {uploadButton}
</Upload>
```
